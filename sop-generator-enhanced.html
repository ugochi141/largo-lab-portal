<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced SOP Generator - Largo Lab</title>
    <link rel="stylesheet" href="css/kp-styles.css">
    <link rel="stylesheet" href="css/main.css">
    <style>
        .sop-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .sop-editor-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .sop-sidebar {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sop-main {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .upload-zone {
            border: 2px dashed #0066cc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8fbff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-zone:hover {
            border-color: #0052a3;
            background: #e7f3ff;
        }

        .upload-zone.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .image-preview-item {
            position: relative;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
        }

        .editor-toolbar {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .toolbar-btn {
            background: white;
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .toolbar-btn:hover {
            background: #e9ecef;
        }

        .toolbar-btn.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        #sopEditor {
            min-height: 500px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            overflow-y: auto;
        }

        #sopEditor:focus {
            outline: none;
            border-color: #0066cc;
        }

        .sop-template {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sop-template:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .btn-primary {
            background: #0066cc;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .file-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        @media print {
            .sop-sidebar,
            .editor-toolbar,
            button {
                display: none !important;
            }

            .sop-editor-grid {
                grid-template-columns: 1fr;
            }

            #sopEditor {
                border: none;
                min-height: auto;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <h1 class="portal-title">Enhanced SOP Generator</h1>
            <nav class="main-nav">
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="manager-dashboard.html" class="nav-link">Dashboard</a></li>
                    <li><a href="sop-generator-enhanced.html" class="nav-link active">SOP Generator</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="sop-container">
            <h2>Standard Operating Procedure Generator</h2>
            <p>Create professional SOPs with images, formatting, and automatic templates</p>

            <div id="alertMessage" class="alert" style="display: none;"></div>

            <div class="sop-editor-grid">
                <!-- Sidebar -->
                <div class="sop-sidebar">
                    <h3>SOP Details</h3>

                    <div class="form-group">
                        <label for="sopTitle">SOP Title</label>
                        <input type="text" id="sopTitle" placeholder="e.g., Urinalysis Procedure">
                    </div>

                    <div class="form-group">
                        <label for="sopNumber">SOP Number</label>
                        <input type="text" id="sopNumber" placeholder="e.g., SOP-LAB-001">
                    </div>

                    <div class="form-group">
                        <label for="sopDepartment">Department</label>
                        <select id="sopDepartment">
                            <option value="">Select Department</option>
                            <option value="chemistry">Chemistry</option>
                            <option value="hematology">Hematology</option>
                            <option value="urinalysis">Urinalysis</option>
                            <option value="coagulation">Coagulation</option>
                            <option value="microbiology">Microbiology</option>
                            <option value="molecular">Molecular</option>
                            <option value="poct">Point of Care</option>
                            <option value="general">General Laboratory</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sopVersion">Version</label>
                        <input type="text" id="sopVersion" value="1.0" placeholder="1.0">
                    </div>

                    <div class="form-group">
                        <label for="sopEffectiveDate">Effective Date</label>
                        <input type="date" id="sopEffectiveDate">
                    </div>

                    <h3 style="margin-top: 30px;">Templates</h3>
                    <div class="sop-template" onclick="loadTemplate('standard')">
                        üìÑ Standard SOP Template
                    </div>
                    <div class="sop-template" onclick="loadTemplate('safety')">
                        ‚ö†Ô∏è Safety Procedure
                    </div>
                    <div class="sop-template" onclick="loadTemplate('maintenance')">
                        üîß Maintenance Procedure
                    </div>
                    <div class="sop-template" onclick="loadTemplate('qc')">
                        ‚úÖ Quality Control Procedure
                    </div>

                    <h3 style="margin-top: 30px;">Actions</h3>
                    <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="saveSOP()">üíæ Save Draft</button>
                    <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="exportToPDF()">üìÑ Export to PDF</button>
                    <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="printSOP()">üñ®Ô∏è Print</button>
                    <button class="btn-secondary" style="width: 100%;" onclick="clearAll()">üóëÔ∏è Clear All</button>
                </div>

                <!-- Main Editor -->
                <div class="sop-main">
                    <h3>Image Upload</h3>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">üì§ Drag & Drop Images or Click to Upload</p>
                        <p style="font-size: 0.9em; color: #666;">Supports: JPG, PNG, GIF, SVG (Max 5MB each)</p>
                        <p style="font-size: 0.9em; color: #666;">Also supports: DOC, DOCX, PDF, HTML for text extraction</p>
                        <input type="file" id="fileInput" multiple accept="image/*,.doc,.docx,.pdf,.html" style="display: none;" onchange="handleFiles(this.files)">
                    </div>

                    <div class="image-preview-grid" id="imagePreview"></div>

                    <h3>SOP Content</h3>
                    <div class="editor-toolbar">
                        <button class="toolbar-btn" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                        <button class="toolbar-btn" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                        <button class="toolbar-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                        <button class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Numbered List">1. 2. 3.</button>
                        <button class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ ‚Ä¢ ‚Ä¢</button>
                        <button class="toolbar-btn" onclick="formatText('justifyLeft')" title="Align Left">‚Üê</button>
                        <button class="toolbar-btn" onclick="formatText('justifyCenter')" title="Center">‚Üî</button>
                        <button class="toolbar-btn" onclick="formatText('justifyRight')" title="Align Right">‚Üí</button>
                        <button class="toolbar-btn" onclick="insertTable()" title="Insert Table">üìä Table</button>
                        <button class="toolbar-btn" onclick="insertHeading()" title="Insert Heading">H1</button>
                        <button class="toolbar-btn" onclick="undo()" title="Undo">‚Ü∂ Undo</button>
                        <button class="toolbar-btn" onclick="redo()" title="Redo">‚Ü∑ Redo</button>
                    </div>

                    <div id="sopEditor" contenteditable="true">
                        <p>Start typing your SOP content here...</p>
                    </div>

                    <div class="file-info" id="fileInfo"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-container">
            <p>&copy; 2025 Kaiser Permanente Largo Laboratory. All rights reserved.</p>
        </div>
    </footer>

    <script>
        (function() {
            'use strict';

            let uploadedImages = [];
            let sopHistory = [];
            let historyIndex = -1;

            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                loadDraft();
                setupDragDrop();
                setupAutoSave();
                setDefaultDate();
            });

            /**
             * Set default effective date to today
             */
            function setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('sopEffectiveDate').value = today;
            }

            /**
             * Setup drag and drop
             */
            function setupDragDrop() {
                const zone = document.getElementById('uploadZone');

                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('dragover');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('dragover');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    handleFiles(e.dataTransfer.files);
                });
            }

            /**
             * Handle file uploads
             */
            window.handleFiles = function(files) {
                const fileInfo = document.getElementById('fileInfo');
                let infoText = '';

                Array.from(files).forEach(file => {
                    // Check file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        showAlert(`File ${file.name} is too large. Maximum size is 5MB.`, 'error');
                        return;
                    }

                    // Handle images
                    if (file.type.startsWith('image/')) {
                        handleImageUpload(file);
                    }
                    // Handle documents
                    else if (file.name.endsWith('.doc') || file.name.endsWith('.docx') ||
                             file.name.endsWith('.pdf') || file.name.endsWith('.html')) {
                        handleDocumentUpload(file);
                        infoText += `Uploaded: ${file.name} (Text extraction available)\n`;
                    }
                });

                if (infoText) {
                    fileInfo.textContent = infoText;
                }
            };

            /**
             * Handle image upload
             */
            function handleImageUpload(file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const imageData = {
                        name: file.name,
                        data: e.target.result,
                        size: file.size
                    };

                    uploadedImages.push(imageData);
                    displayImagePreview(imageData, uploadedImages.length - 1);
                    showAlert(`Image ${file.name} uploaded successfully!`, 'success');
                };

                reader.readAsDataURL(file);
            }

            /**
             * Display image preview
             */
            function displayImagePreview(imageData, index) {
                const preview = document.getElementById('imagePreview');
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                item.innerHTML = `
                    <img src="${imageData.data}" alt="${imageData.name}">
                    <button class="remove-btn" onclick="removeImage(${index})" title="Remove">√ó</button>
                `;
                item.onclick = function(e) {
                    if (e.target.className !== 'remove-btn') {
                        insertImageToEditor(imageData);
                    }
                };
                preview.appendChild(item);
            }

            /**
             * Remove image
             */
            window.removeImage = function(index) {
                uploadedImages.splice(index, 1);
                refreshImagePreviews();
            };

            /**
             * Refresh image previews
             */
            function refreshImagePreviews() {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = '';
                uploadedImages.forEach((img, idx) => {
                    displayImagePreview(img, idx);
                });
            }

            /**
             * Insert image to editor
             */
            function insertImageToEditor(imageData) {
                const editor = document.getElementById('sopEditor');
                const img = document.createElement('img');
                img.src = imageData.data;
                img.alt = imageData.name;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.margin = '10px 0';

                // Insert at cursor position or end
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(img);
                } else {
                    editor.appendChild(img);
                }

                showAlert('Image inserted into SOP!', 'success');
            }

            /**
             * Handle document upload (simplified - shows intent)
             */
            function handleDocumentUpload(file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    // In production, this would use proper libraries to extract text
                    // For now, we'll note that the file was uploaded
                    showAlert(`Document ${file.name} uploaded. Text extraction would occur here.`, 'info');
                };

                reader.readAsText(file);
            }

            /**
             * Format text in editor
             */
            window.formatText = function(command) {
                document.execCommand(command, false, null);
                document.getElementById('sopEditor').focus();
            };

            /**
             * Insert table
             */
            window.insertTable = function() {
                const rows = prompt('Number of rows:', '3');
                const cols = prompt('Number of columns:', '3');

                if (rows && cols) {
                    let table = '<table border="1" style="width: 100%; border-collapse: collapse; margin: 10px 0;"><tbody>';
                    for (let i = 0; i < rows; i++) {
                        table += '<tr>';
                        for (let j = 0; j < cols; j++) {
                            table += '<td style="padding: 8px; border: 1px solid #ccc;">Cell</td>';
                        }
                        table += '</tr>';
                    }
                    table += '</tbody></table>';

                    document.execCommand('insertHTML', false, table);
                }
            };

            /**
             * Insert heading
             */
            window.insertHeading = function() {
                const text = prompt('Heading text:', '');
                if (text) {
                    document.execCommand('insertHTML', false, `<h3>${text}</h3>`);
                }
            };

            /**
             * Undo
             */
            window.undo = function() {
                document.execCommand('undo', false, null);
            };

            /**
             * Redo
             */
            window.redo = function() {
                document.execCommand('redo', false, null);
            };

            /**
             * Load template
             */
            window.loadTemplate = function(type) {
                const templates = {
                    standard: `
                        <h2>1. PURPOSE</h2>
                        <p>Describe the purpose of this SOP...</p>

                        <h2>2. SCOPE</h2>
                        <p>Define the scope of application...</p>

                        <h2>3. RESPONSIBILITIES</h2>
                        <p>List personnel responsibilities...</p>

                        <h2>4. MATERIALS AND EQUIPMENT</h2>
                        <ul>
                            <li>Item 1</li>
                            <li>Item 2</li>
                        </ul>

                        <h2>5. PROCEDURE</h2>
                        <ol>
                            <li>Step 1</li>
                            <li>Step 2</li>
                            <li>Step 3</li>
                        </ol>

                        <h2>6. QUALITY CONTROL</h2>
                        <p>Describe QC procedures...</p>

                        <h2>7. REFERENCES</h2>
                        <p>List relevant references...</p>

                        <h2>8. REVISION HISTORY</h2>
                        <table border="1" style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <th style="padding: 8px;">Version</th>
                                <th style="padding: 8px;">Date</th>
                                <th style="padding: 8px;">Changes</th>
                                <th style="padding: 8px;">Author</th>
                            </tr>
                            <tr>
                                <td style="padding: 8px;">1.0</td>
                                <td style="padding: 8px;">${new Date().toLocaleDateString()}</td>
                                <td style="padding: 8px;">Initial release</td>
                                <td style="padding: 8px;"></td>
                            </tr>
                        </table>
                    `,
                    safety: `
                        <h2>SAFETY PROCEDURE</h2>
                        <h3>‚ö†Ô∏è HAZARDS</h3>
                        <ul>
                            <li>List potential hazards...</li>
                        </ul>

                        <h3>üõ°Ô∏è PERSONAL PROTECTIVE EQUIPMENT (PPE)</h3>
                        <ul>
                            <li>Lab coat</li>
                            <li>Gloves</li>
                            <li>Safety glasses</li>
                        </ul>

                        <h3>üìã SAFETY PROCEDURES</h3>
                        <ol>
                            <li>Step 1...</li>
                        </ol>

                        <h3>üö® EMERGENCY PROCEDURES</h3>
                        <p>In case of emergency...</p>
                    `,
                    maintenance: `
                        <h2>MAINTENANCE PROCEDURE</h2>
                        <h3>üîß DAILY MAINTENANCE</h3>
                        <ul>
                            <li>Task 1</li>
                        </ul>

                        <h3>üìÖ WEEKLY MAINTENANCE</h3>
                        <ul>
                            <li>Task 1</li>
                        </ul>

                        <h3>üìÜ MONTHLY MAINTENANCE</h3>
                        <ul>
                            <li>Task 1</li>
                        </ul>

                        <h3>üìù MAINTENANCE LOG</h3>
                        <p>Record all maintenance activities in the maintenance log.</p>
                    `,
                    qc: `
                        <h2>QUALITY CONTROL PROCEDURE</h2>
                        <h3>‚úÖ QC MATERIALS</h3>
                        <ul>
                            <li>Control Level 1 (Low)</li>
                            <li>Control Level 2 (Normal)</li>
                            <li>Control Level 3 (High)</li>
                        </ul>

                        <h3>üìä QC FREQUENCY</h3>
                        <p>Perform QC testing...</p>

                        <h3>üìà ACCEPTABLE RANGES</h3>
                        <table border="1" style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <th style="padding: 8px;">Analyte</th>
                                <th style="padding: 8px;">Level</th>
                                <th style="padding: 8px;">Target</th>
                                <th style="padding: 8px;">SD</th>
                            </tr>
                        </table>

                        <h3>üî¥ OUT OF CONTROL PROCEDURES</h3>
                        <ol>
                            <li>Repeat the QC test</li>
                            <li>Check reagents and calibrators</li>
                            <li>Review instrument maintenance</li>
                            <li>Contact supervisor if issue persists</li>
                        </ol>
                    `
                };

                document.getElementById('sopEditor').innerHTML = templates[type] || templates.standard;
                showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} template loaded!`, 'success');
            };

            /**
             * Save SOP draft
             */
            window.saveSOP = function() {
                const sopData = {
                    title: document.getElementById('sopTitle').value,
                    number: document.getElementById('sopNumber').value,
                    department: document.getElementById('sopDepartment').value,
                    version: document.getElementById('sopVersion').value,
                    effectiveDate: document.getElementById('sopEffectiveDate').value,
                    content: document.getElementById('sopEditor').innerHTML,
                    images: uploadedImages,
                    savedAt: new Date().toISOString()
                };

                localStorage.setItem('sop_draft', JSON.stringify(sopData));
                showAlert('SOP draft saved successfully!', 'success');
            };

            /**
             * Load draft
             */
            function loadDraft() {
                const draft = localStorage.getItem('sop_draft');
                if (draft) {
                    const sopData = JSON.parse(draft);
                    document.getElementById('sopTitle').value = sopData.title || '';
                    document.getElementById('sopNumber').value = sopData.number || '';
                    document.getElementById('sopDepartment').value = sopData.department || '';
                    document.getElementById('sopVersion').value = sopData.version || '1.0';
                    document.getElementById('sopEffectiveDate').value = sopData.effectiveDate || '';
                    document.getElementById('sopEditor').innerHTML = sopData.content || '';
                    uploadedImages = sopData.images || [];
                    refreshImagePreviews();
                }
            }

            /**
             * Auto-save every 30 seconds
             */
            function setupAutoSave() {
                setInterval(() => {
                    const content = document.getElementById('sopEditor').innerHTML;
                    if (content && content.length > 50) {
                        saveSOP();
                        console.log('Auto-saved at', new Date().toLocaleTimeString());
                    }
                }, 30000);
            }

            /**
             * Export to PDF (simplified - would use library in production)
             */
            window.exportToPDF = function() {
                const title = document.getElementById('sopTitle').value || 'Untitled SOP';
                showAlert(`Export to PDF would generate: ${title}.pdf\n\nUse browser Print > Save as PDF for now.`, 'info');
                setTimeout(() => window.print(), 1000);
            };

            /**
             * Print SOP
             */
            window.printSOP = function() {
                window.print();
            };

            /**
             * Clear all
             */
            window.clearAll = function() {
                if (confirm('Clear all content and start fresh? This will delete your current draft.')) {
                    document.getElementById('sopTitle').value = '';
                    document.getElementById('sopNumber').value = '';
                    document.getElementById('sopDepartment').value = '';
                    document.getElementById('sopVersion').value = '1.0';
                    document.getElementById('sopEditor').innerHTML = '<p>Start typing your SOP content here...</p>';
                    uploadedImages = [];
                    refreshImagePreviews();
                    localStorage.removeItem('sop_draft');
                    setDefaultDate();
                    showAlert('All content cleared!', 'success');
                }
            };

            /**
             * Show alert message
             */
            function showAlert(message, type = 'info') {
                const alert = document.getElementById('alertMessage');
                alert.className = `alert ${type}`;
                alert.textContent = message;
                alert.style.display = 'block';

                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }

        })();
    </script>
</body>
</html>
